name: å‡ºå£èŠ‚ç‚¹OK Linux Server

on:
  workflow_dispatch:
    inputs:
      server_password:
        description: 'Server Password'
        required: true
        default: 'MyServer@2025!'
        type: string

jobs:
  secure-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: æ£€æŸ¥æ‰‹åŠ¨è§¦å‘
        run: |
          echo "âœ… å·¥ä½œæµæ‰‹åŠ¨è§¦å‘æˆåŠŸï¼"
          echo "ğŸ“ è¾“å…¥å¯†ç : ${{ github.event.inputs.server_password }}"
          echo "ğŸ†” è¿è¡ŒID: $GITHUB_RUN_ID"
          echo "ğŸ”§ è§¦å‘äº‹ä»¶: $GITHUB_EVENT_NAME"

      - name: å®‰è£…åŸºç¡€å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget unzip net-tools

      - name: åˆ›å»ºç®¡ç†ç”¨æˆ·
        run: |
          SERVER_PASSWORD="${{ github.event.inputs.server_password }}"
          sudo useradd -m -s /bin/bash SERVERADMIN 2>/dev/null || true
          echo "SERVERADMIN:$SERVER_PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo SERVERADMIN
          echo "SERVER_PASSWORD=$SERVER_PASSWORD" >> $GITHUB_ENV
          echo "âœ… ç”¨æˆ· SERVERADMIN åˆ›å»ºæˆåŠŸ"

      - name: å®‰è£… Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update
          sudo apt-get install -y tailscale
          echo "âœ… Tailscale å®‰è£…æˆåŠŸ"

      - name: é…ç½®ç½‘ç»œå’Œå‡ºå£èŠ‚ç‚¹
        run: |
          # å¯ç”¨ IP è½¬å‘
          echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.conf
          echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p
          
          # æ£€æµ‹æœ¬åœ°å­ç½‘
          SUBNET=$(ip route | grep default | awk '{print $3}' | cut -d. -f1-3).0/24
          echo "ADVERTISE_ROUTES=$SUBNET" >> $GITHUB_ENV
          echo "ğŸŒ æ£€æµ‹åˆ°çš„å­ç½‘: $SUBNET"

      - name: è¿æ¥ Tailscale
        run: |
          echo "ğŸ”— æ­£åœ¨è¿æ¥ Tailscale..."
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-runner-$GITHUB_RUN_ID \
            --advertise-exit-node \
            --advertise-routes=$ADVERTISE_ROUTES
          
          # ç­‰å¾…è·å– Tailscale IP
          for i in {1..10}; do
            TAILSCALE_IP=$(tailscale ip -4)
            if [ -n "$TAILSCALE_IP" ]; then
              break
            fi
            echo "â³ ç­‰å¾… Tailscale IP åˆ†é…... ($i/10)"
            sleep 5
          done
          
          if [ -z "$TAILSCALE_IP" ]; then
            echo "âŒ é”™è¯¯: æ— æ³•è·å– Tailscale IP"
            exit 1
          fi
          
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "âœ… Tailscale IP: $TAILSCALE_IP"

      - name: å®‰è£… KO30RE æœåŠ¡
        run: |
          echo "â¬‡ï¸ ä¸‹è½½å¹¶å®‰è£… KO30RE..."
          sudo mkdir -p /opt/ko30re
          cd /opt/ko30re
          
          # ä¸‹è½½è„šæœ¬
          sudo curl -L https://r2.916919.xyz/ko30re/top.sh -o top.sh
          sudo chmod +x top.sh
          
          # ç›´æ¥åœ¨åå°è¿è¡Œï¼ˆé¿å… systemd é—®é¢˜ï¼‰
          sudo bash -c "
          export NZ_SERVER=ko30re.916919.xyz:443
          export NZ_TLS=true
          export NZ_CLIENT_SECRET=kO3irsfICJvxqZFUE2bVHGbv2YQpd0Re
          cd /opt/ko30re
          nohup ./top.sh > /var/log/ko30re.log 2>&1 &
          echo \$! > /var/run/ko30re.pid
          echo 'ğŸ“ è¿›ç¨‹ID: ' \$(cat /var/run/ko30re.pid)
          "
          
          sleep 10
          echo "âœ… KO30RE å¯åŠ¨å®Œæˆ"

      - name: éªŒè¯æœåŠ¡çŠ¶æ€
        run: |
          echo "ğŸ” éªŒè¯æœåŠ¡çŠ¶æ€..."
          echo "ğŸ“¡ Tailscale çŠ¶æ€:"
          sudo tailscale status
          
          echo "ğŸ–¥ï¸ KO30RE è¿›ç¨‹çŠ¶æ€:"
          if ps aux | grep -q top.sh | grep -v grep; then
            echo "âœ… KO30RE è¿›ç¨‹è¿è¡Œä¸­"
            KO30RE_PID=$(ps aux | grep top.sh | grep -v grep | awk '{print $2}')
            echo "ğŸ“ è¿›ç¨‹PID: $KO30RE_PID"
          else
            echo "âŒ KO30RE è¿›ç¨‹æœªè¿è¡Œ"
          fi

      - name: æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
        run: |
          echo ""
          echo "=========================================="
          echo "            ğŸš€ æœåŠ¡å™¨éƒ¨ç½²å®Œæˆ ğŸš€"
          echo "=========================================="
          echo "ğŸ“¡ Tailscale IP: $TAILSCALE_IP"
          echo "ğŸ‘¤ SSH ç”¨æˆ·å: SERVERADMIN"
          echo "ğŸ”‘ SSH å¯†ç : $SERVER_PASSWORD"
          echo "ğŸ”— KO30RE æœåŠ¡: è¿è¡Œä¸­"
          echo ""
          echo "ğŸ“‹ ä½¿ç”¨è¯´æ˜:"
          echo "1. SSH è¿æ¥: ssh SERVERADMIN@$TAILSCALE_IP"
          echo "2. å¯ç”¨å‡ºå£èŠ‚ç‚¹:"
          echo "   è®¿é—®: https://login.tailscale.com/admin/machines"
          echo "   æ‰¾åˆ°è®¾å¤‡: gh-runner-$GITHUB_RUN_ID"
          echo "   å¯ç”¨ 'ç”¨ä½œå‡ºå£èŠ‚ç‚¹'"
          echo ""
          echo "ğŸ”§ è°ƒè¯•å‘½ä»¤:"
          echo "æŸ¥çœ‹ KO30RE æ—¥å¿—: sudo tail -f /var/log/ko30re.log"
          echo "æŸ¥çœ‹è¿›ç¨‹: ps aux | grep top.sh"
          echo "Tailscale çŠ¶æ€: tailscale status"
          echo "=========================================="

      - name: ä¿æŒè¿è¡Œ
        run: |
          echo "ğŸ”„ è¿›å…¥ä¿æŒè¿è¡Œæ¨¡å¼..."
          counter=0
          while [ $counter -lt 360 ]; do
            echo "[$(date +'%H:%M:%S')] è¿è¡Œä¸­... ($((counter/2))åˆ†é’Ÿ)"
            echo "ğŸ“Š çŠ¶æ€:"
            echo "  - Tailscale IP: $TAILSCALE_IP"
            
            # æ£€æŸ¥è¿›ç¨‹
            if ps aux | grep -q top.sh | grep -v grep; then
              echo "  - KO30RE: âœ… è¿è¡Œä¸­"
            else
              echo "  - KO30RE: âŒ å·²åœæ­¢"
            fi
            
            # æ£€æŸ¥ Tailscale
            if tailscale status > /dev/null 2>&1; then
              echo "  - Tailscale: âœ… å·²è¿æ¥"
            else
              echo "  - Tailscale: âŒ è¿æ¥æ–­å¼€"
            fi
            
            echo "----------------------------------------"
            sleep 30
            counter=$((counter + 1))
          done
          echo "â¹ï¸ è¿è¡Œæ—¶é—´ç»“æŸ"
